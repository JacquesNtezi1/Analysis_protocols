---
title: 'Maize and Beans Yield Response to Fertilizer Types (A and B) in Bugarama Region  '
author: "mailto:jacques.ntezimana@oneacrefund.org"
date: "August 2017"
output:
  html_document:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 6
  word_document:
    toc: yes
    toc_depth: '6'
subtitle: Bugarama RCBD Trial
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load libraries
library(data.table)
library(ggplot2)
library(reshape2)
library(plyr)
library(stats)
library(lattice)
library(gridExtra)
library(pwr)
library(rmarkdown)
# define function that turns decimal percentages into pretty formats
format_pct <- function(num) {round(num*100, digits = 2)}

# define function to adjust table widths
html_table_width <- function(kable_output, width){
  width_html <- paste0(paste0('<col width="', width, '">'), collapse = "\n")
  sub("<table>", paste0("<table>\n", width_html), kable_output)
}


```

# Summary 

## Overview 

For profitable production, Beans and Maize require adequate fertilizer application. Applying the right fertilizers at the right rate and at the right time is crucial for a successful crop. The aim of this report is  to determine which type  of fertilizer leads to the highest Yield  for Maize and/or Beans in the Bugarama region. Field experiment was carried out  and Maize and Beans were grown with fertilzer grade A and B by 500 participants for each types of fertilizer.

# Trial Hypothesis 

The type B fertilizer  will produce significantly higher Maize yields than type A fertilizer. 
The type B fertilizer  will produce significantly higher Beans yields than type A fertilizer. 

# Main Take Away
## Summary of Results 
Add note here afte get all results 

## Data quality disclaimer

 Here, walk through fixing any missing data, outliers  issues, merging data and any problems with the dataset.

# Recommnadation 

Based on results , what is trial recommendation 

```{r assignment}
# create directory 

wd <- "C:/Users/Admin/Desktop/r_directory/AInnovations/Analyst Mentorship Program/AMP"
dd <- paste(wd, "data", sep="/")
od <- paste(wd, "output", sep="/")

## call data 
c <- read.csv(paste(dd, "Homework_data.csv", sep = "/"), header = TRUE, stringsAsFactors = FALSE) ## cases 

```
#Analysis 
 
##Diagonostic testing 

###Data exploration by box-plots

```{r boxplots}
# data  visualization for outlier check

g1 <- ggplot(c, aes(x=Group, y=Maize.yield.per.acre, fill=Group)) + geom_boxplot() +
    guides(fill=FALSE) + ylab("Maize yields kg per acre")+ggtitle("Maize Fertilizer types application")

g2 <- ggplot(c, aes(x=Group, y=Beans.yield.per.acre, fill=Group)) + geom_boxplot() +
    guides(fill=FALSE) + ylab("Beans  yields kg per acre")+ggtitle("Beans Fertilizer types application")

grid.arrange(g1, g2, ncol=2) 

```

Typically, box-plot allow us to see the distribution of a variable data and whether they contain outliers or not.  Indeed, those plotted box-lots  are helping us see the performance of Fert.A and Fert.B on Maize and Beans Yields(kg) per Acre.Results revealed that Fert.B has good performance compared to Fert.A for both Maize and Beans yields. But in this particular case, boxplots have helped to investigate something specific. It reveals some information on the oultiers for beans yields that there're large numbers  of kg  that max out near 160 for both Fertizer types and also has some outlers at low end . 

Since some of the Beans data are unusual compared to the others which can have strong influence on the results, we should try to identify the cause of the unusual nature points. we can however choose to correct any data entry or measurement error, then consider removing data that are associated with special causes and repeating analysis.

### Test of normality of data 
#### QQ-plot

```{r qq plot}

# QQ plot  all data ( both group togetheer )

par(mfrow = c(1, 2))

qqnorm(c$Maize.yield.per.acre, main="QQ plot Maize Yield ")
qqline(c$Maize.yield.per.acre)

qqnorm(log(c$Maize.yield.per.acre), main="QQ plot Beans Yield")
qqline(log(c$Beans.yield.per.acre))

## QQ-plots for subgroup 
## create subsets

c1 <- subset(c,Group=="Fert.A", select=ID:Group)
c2 <- subset(c,Group=="Fert.B", select=ID:Group)

### maize
par(mfrow = c(1, 2))
qqnorm(c1$Maize.yield.per.acre, main="QQ plot Maize Yield  Fert.A")
qqline(c1$Maize.yield.per.acre)

qqnorm(c2$Maize.yield.per.acre, main="QQ plot Maize Yield  Fert.B")
qqline(c2$Maize.yield.per.acre)

### Beans
par(mfrow = c(1, 2))
qqnorm(c1$Beans.yield.per.acre, main="QQ plot Beans Yield  Fert.A")
qqline(c1$Beans.yield.per.acre)

qqnorm(c2$Beans.yield.per.acre, main="QQ plot Beans Yield  Fert.B")
qqline(c2$Beans.yield.per.acre)

```

As QQ-plot plots a perfect normal distribution as a solid diagonal line and then our actual data as markers (circles) on top of that. Therefore, the plotted  entire data(Fert.A&B) for beans yield shows some non-normal distribution while Maize yield data shows normal distribution trend. 

However the plots look opposite when data are plotted in subgroups. The QQ-plots for beans show that both Fert.A and Fert.B data follow a normal distribution while examining the data in plot of Maize yield,Fert.B follows the normality but has some slighty deviation at the bottom while  Fert.A has  deviated from the normal line. 

How do we resolve this discrepancy? Le's run Shapiro test to see whether those systematic deviations from the normal line exist or not .

#### Shapiro-Wilk normality test

```{r test of normality}

## Shapiro test  
## Just to remember that c is  a dataframe for all groups data, c1 is subset for Fert.A only ,c2 IS for Fer.B 

shapiro.test(c$Maize.yield.per.acre) 
shapiro.test(c$Beans.yield.per.acre)

shapiro.test(c1$Maize.yield.per.acre) 
shapiro.test(c2$Maize.yield.per.acre) 

shapiro.test(c1$Beans.yield.per.acre)
shapiro.test(c2$Beans.yield.per.acre)

```

Our Maize yields distribution has a Shapiro test P-value <5%  for all  Fertizer types A&B and when  tested both togetheR. This is strongly suggests  that our Maize data is non- normal. while  Beans yields data,  shaporo test P-Values > 5%  this indicates that data are normal. Those are some terrible looking QQ-plots, and some really with low P-valueslike Maize Yield data!

## Test of Significance 

Since the results from Shapiro test suggests the normality for Beans Data and non-normal for Maize data, it is recommended to use different test statistic.  Non-parametric test is recommended for non-normal data, vs parametric test when data are normal. Therefore ,to test the mean difference between Fert.A  and fert B for Beans data which are  normal , Welch Test( An improvement on the T-test, which is more robust to unequal variances)  is recommended while the Wilcoxon Test is recommended for Maize Yield data that  are not normal.

### Welch Test , test of mean difference among two types of fertilizer A and B  for  Beans Yield


```{r test of mean difference }

## Welch Test 
t.test(Beans.yield.per.acre~Group, alternative = "two.sided", var.equal = FALSE, data=c)$p.value #perform the Welch test and store p-value

## Let us verify results using T test 

t.test(Beans.yield.per.acre~Group, alternative = "two.sided", var.equal = TRUE, data=c)$p.value # We have gotten similar result because the variance is almost the same
 
```

add note here  

### Wilcoxon Test , test of mean difference among two types of fertilizer A and B  for  Maize Yield

```{r test of mean difference wilcoxon }

## Wilcoxon Test 

wilcox.test(Maize.yield.per.acre~Group,paired=FALSE, correct=TRUE,data=c)

## let us verify results using T.test
t.test(Maize.yield.per.acre~Group, alternative = "two.sided", var.equal = TRUE, data=c) # has produce significance which should not be always promises , we must  use the right test at the right time. 

```

## Power Analysis  

Our results have shown no difference in mean yield of Beans among  Fertilizer A and B ( Welch test P-values=0.165 > 5%)  and found to have statistically significant difference for Maize (Welcoxon Test p-value = 4.565e-05 <5%) . However , there is a need of performing  power calculations to assess whether the presence  or lack of impact is due to the sample size, inherent to the intervention itself, or due to some other reason such as implementation failure or something else. 

### Power calculation 

It is important that we use the correct power calculation in much the same way it is important we use the right hypothesis test.A low power will mean our results are less reliable and we may be making false conclusions about interventions.The required sample size to detect the effect of interest  will need to produce the power of 0.8 and above . Power calculations are dependent on the data distribution , therefore  with normal data , " pwr.2p2n.test " will be used from the "pwr"library while "McPower" will be used for Non normal data . 

Also since sample size, power and effect size are all part of the same equation and all related.We will first need to calculate effect size which is difference in means between samples divided by the standard deviation of the samples. This means the units are in standard deviations using Cohen's D equation .

#### Power calculation  for normal ( Beans Yield )
```{r power }

# Generate effect size using Cohen D equation  (Note that c1 is dataframe that contain Data for Fert.A while c2 contain data for Fert.B)
#Don't forget to re run the command that generate c1 and c2 in above codes

cohen_d <- function(c1,c2) {  
  m1 <- mean(c1$Beans.yield.per.acre, na.rm=TRUE)
  m2 <- mean(c2$Beans.yield.per.acre, na.rm=TRUE)
  s1 <- sd(c1$Beans.yield.per.acre, na.rm=TRUE)
  s2 <- sd(c2$Beans.yield.per.acre, na.rm=TRUE)
  spo <- sqrt((s1**2 + s2**2)/2)
  d <- (m1 - m2)/spo
  effsi <- d / sqrt((d**2)+4)
  ret <- list("d" = d, "effectsi" = effsi)
  return(ret)  } 

##get effect size and call it like this:
 
vals<- cohen_d(c1, c2)
 
pwr.2p2n.test(h = vals$effectsi , n1 =length(c1$Group), n2=length(c2$Group) , sig.level = 0.05, power = NULL)

```

With the result calculated above , a statistical power of 0.106 was obtained , which means a weak power . Therefore ,it can be said with only 11% of certainly that there is no really a statistically significant difference between the beans'mean yields for two types of fertilizers . 

#### Power calculation  for non-normal ( Maize Yield )

```{r nonnormal}





```



